
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>@ijin</title>
  <meta name="author" content="Michael H. Oshita">

  
  <meta name="description" content="AWS Lambda上でsshやgitを使えたら便利！思ったけど、そもそもバイナリ自体が入ってない上にパッケージのインストールが出来ないので回避方法を悩んでいたところ、幸いそれぞれPython nativeの実装があったので先人の肩に乗っかる事で事無きを得ました。 SSH &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ijin.github.io/blog/page/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="@ijin" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<!--<script type="text/javascript">
document.base_document_write = document.write;
document.write = function(html) {
    if (html.match(/^<link rel="stylesheet".+gist-assets\.github\.com\/assets\/embed.*/) == null) {
        document.base_document_write(html);
    }
}
</script>

-->

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-33110241-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">@ijin</a></h1>
  
    <h2>[Michael H. Oshita]</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ijin.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/18/ssh-and-git-on-aws-lambda/">LambdaでSSHやGitを使ってみよう</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-18T12:35:00+09:00" pubdate data-updated="true">Feb 18<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>AWS Lambda上で<code>ssh</code>や<code>git</code>を使えたら便利！思ったけど、そもそもバイナリ自体が入ってない上にパッケージのインストールが出来ないので回避方法を悩んでいたところ、幸いそれぞれPython nativeの実装があったので先人の肩に乗っかる事で事無きを得ました。</p>

<h2>SSH</h2>

<p>SSHは<a href="http://www.paramiko.org">Paramiko</a>というライブラリを利用。s3上に<a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/UsingKMSEncryption.html">SSE-KMS</a>で暗号化されたキーファイルをダウンロードし、それを使ってサーバと認証しログイン。</p>

<p>注意点</p>

<ul>
<li>Lambdaの実行環境にはデフォルトでParamikoが入ってないので、deployment packageに含める必要がある</li>
<li>Mac上ではpythonライブラリの互換性が衝突する為、Linux（EC2等）上でpackageを作成する必要がある</li>
<li>最近発表された<a href="https://aws.amazon.com/blogs/aws/new-access-resources-in-a-vpc-from-your-lambda-functions/">VPC対応</a>を使ってprivate networkで通信をしたい場合、外部への経路はそのままでは不可なので、s3の場合はVPC endpointを作成するかNATが必要になってくる。詳しくはこの<a href="http://qiita.com/ijin/items/94c0bc4b8f6f5e77a591">記事</a>を。</li>
</ul>


<div><script src='https://gist.github.com/26afca1e9b03ecaf4d8e.js?file='></script>
<noscript><pre><code></code></pre></noscript></div>


<h2>Git</h2>

<p>Gitは<a href="https://github.com/jelmer/dulwich"><code>dulwich</code></a>というライブラリを利用。sshプロトコルの場合、デフォルトではシステム上のsshが利用されるのでPython版の<code>ParamikoSSHVendor</code>クラスを使えばすんなりいくと思いきや、キーファイル指定が出来なかったのでそこを少し改変。また、Lambda上での特殊な環境の為か<code>sys.stderr</code> のencode周りがうまく検出されなかったので、<code>dulwich.porcelain.push</code> methodも若干修正。</p>

<p>Paramikoを使っているので、上記同様パッケージ作成はLinux上で。</p>

<p>以下はprivate repositoryをclone後、別branchに新規ファイルを追加後にcommitし、githubへpushする例。</p>

<div><script src='https://gist.github.com/080822d2c7859b528631.js?file='></script>
<noscript><pre><code></code></pre></noscript></div>


<p>それでは、良いLambdaライフを！</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/14/monitor-lambda-capacity/">Lambdaの容量を監視しよう</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-14T05:23:00+09:00" pubdate data-updated="true">Jan 14<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><code>2016/1/14</code>現在、AWS Lambdaにはなんと<strong>リージョン</strong>毎！にアップロードできるパッケージの合計サイズがたったの<strong>1.5GB</strong>という<a href="http://docs.aws.amazon.com/lambda/latest/dg/limits.html#limits-list">悲しい制限</a>があります。特にlibraryを同包したり、versioningを使ったりしてCIをガンガン回してると、結構すぐこの上限に達してしまいがちです。そこで、Lambdaの総容量はAWSコンソール上には表示されるものの、トラッキングし辛いので監視する仕組みを作ってみました。</p>

<h2>仕組み</h2>

<p>LambdaのScheduled Eventsを使って、<code>ListFunctions</code>と<code>ListVersionsByFunction</code> APIを叩いて、個別functionの<code>CodeSize</code>をサマって、<code>PutMetricData</code>でCloudWatchに投げて、Alarm設定してるだけ。</p>

<script src="https://gist-it.appspot.com/https://github.com/ijin/check_lambda_capacity/blob/master/lambda_function.py"></script>


<p>(*) <code>2016/1/26</code> 追記：<a href="https://twitter.com/marcy_terui">@marcy_terui</a>さんからの<a href="https://twitter.com/marcy_terui/status/689326911634329600">ご指摘</a>でVersionsの容量計算が抜けてました。ありがとうございます。</p>

<p>といっても、今後別アカウントでいちいち設定（IAM role&amp;policy、Lambda、SNS、CloudWatch）するのも非常に面倒くさいので、今回は<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/working-with-templates-cfn-designer.html">CloudFormation Designer</a>を使って、ほぼ一発で環境を再現できるようにしました。</p>

<h2>CloudFormation</h2>

<p>ボタン作ってみた。<a href="https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/new?stackName=check-lambda-capacity&templateURL=https://s3-ap-northeast-1.amazonaws.com/ijin/aws/lambda/check_lambda_capacity/check_lambda_capacity.template">
<img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png">
</a></p>

<h3>Stack Creation</h3>

<p>Designerではこんな感じ。心なしか、jsonの苦痛が多少楽になったような。。後、Propertyの補完機能は良いけどショートカットが<code>Cmd+Space</code>なのでSpotlightさんがぁ。</p>

<p><img src="https://lh3.googleusercontent.com/CLHrqYHPDKPxABDkWdrl0FYbEEC9enKmbOaK75TqhqL5tPnQ8oRjA3_f3N3iJoD5cSanPbbvt9lT=w880-h586-no"></p>

<p>s3からtemplateを指定。
template urlは<code>https://s3-ap-northeast-1.amazonaws.com/ijin/aws/lambda/check_lambda_capacity/check_lambda_capacity.template</code></p>

<p><img src="https://lh3.googleusercontent.com/XeF-yQk1cxy8z8KnHTJS3mP-onExoYmbJ7-OYISmLd3NYxO4fVCQnqAxygAEu6zdMtzEy16641C-=w826-h268-no"></p>

<p>Parameterとしては以下が指定可能</p>

<ul>
<li>アラート閾値（Byte単位）</li>
<li>SNS topic（空の場合は、自動作成される）</li>
</ul>


<p><img src="https://lh3.googleusercontent.com/vX0JiEE_me3Wn6__PbNysmSYVkGiOs4jbqivZm7lOoq18kZpyrV9lj01kL9-rDMCX1JAS7BHVmI4=w902-h509-no"></p>

<p>Stackを作成すると、諸々のリソースが数分で出来上がり。</p>

<p><img src="https://lh3.googleusercontent.com/rQy-Any2cmz9I7YxuGD-Pi8_4VB9dGKFnCbAxWHH4QPjRMF7Y9nKAi2sZPY2HogoL2vpcc8ABy4E=w1050-h260-no"></p>

<h3>Manual Labor</h3>

<p>本当は以上で終了！にしたいところですが、LambdaのScheduled Eventsの設定はAWSコンソールからのみしか出来ないという<del>情けない</del><a href="http://docs.aws.amazon.com/lambda/latest/dg/with-scheduled-events.html">残念な状態</a>（<code>2016/1/14</code>現在）なので、ここからポチポチ設定作業。。（API重視の開発姿勢はどこ行ったんだろう）</p>

<p>(*) <code>2016/1/26</code> 追記：この記事の翌日に発表された <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/DeveloperGuide/WhatIsCloudWatchEvents.html"><code>CloudWatch Events</code></a> の <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/DeveloperGuide/ScheduledEvents.html"><code>scheduling</code> 機能</a> によって出来るようになりました。なんというタイミング。</p>

<p><img src="https://lh3.googleusercontent.com/2pedymzqDYHJ30u7VglVv-7_6IpFhpOnRdnE4-QxjuIdX1fep2FwtoyDNr1Kl5yEqT1rtjoLDLZx=w581-h238-no"></p>

<p><img src="https://lh3.googleusercontent.com/hcLpNX45gIQZQUQGvsyyIXfOH3s9yDpNLIZJN8TU-RUZDdMGdrsNXAb_NRupjWF9Hf4QrK4y6lXO=w864-h441-no"></p>

<p>最小頻度が5分毎
<img src="https://lh3.googleusercontent.com/lzuWtzvkK1A5pUSPyShVaFzzOQ13cD8PFVfCAz3rxSYkn5sKirWnhq-4PlKyhuesMlCQtrfH57yx=w862-h507-no"></p>

<h3>Graph</h3>

<p>これで、グラフが取れて閾値を超えたらアラートが飛ぶようになる</p>

<p><img src="https://lh3.googleusercontent.com/yzswstqCbaTzpkYfy5MlRS2I9ur5Is3hI8Eii-o27twq-fYA_6o8SY5Rrn0DbyZEn8UJarGhh_9L=w570-h270-no"></p>

<p><img src="https://lh3.googleusercontent.com/NE43x1KQW76QO7b4TMIjjcEYrpQ07B9SNOb-9L-wEnNKc8oC-69HpgzWiVABnQwBSNGtDz4ayeTR=w286-h221-no"></p>

<h2>Code</h2>

<p>出来上がったCloudFormation templateコードはこちら。<code>AWS::Lambda::Function</code>がlambdaのresource担当だけど、templateにfunctionをインラインで埋め込めるのは現時点では<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-lambda-function-code.html"><code>nodejs</code>のみ</a>なので仕方なくzipしたpythonコードをs3にアップして参照するようにしてる。</p>

<script src="https://gist-it.appspot.com/https://github.com/ijin/check_lambda_capacity/blob/master/check_lambda_capacity.template"></script>


<p>元気があれば、そのうちnode版も書こうかな。。</p>

<p>GitHubのリポジトリは<a href="https://github.com/ijin/check_lambda_capacity">こちらから</a>。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/18/co-working-in-hubud/">バリ島のHubudでコワークしてきた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-12-18T10:33:00+09:00" pubdate data-updated="true">Dec 18<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>東京で借りているマンションのエレベータが総入れ替えで1週間完全停止する事になったので、ふらっとインドネシアのバリ島に来てみました。
仕事柄リモートワークがしやすいで、ついでにバリ島のウブドというエリアにある噂のコワーキングスペース「<a href="http://www.hubud.org"><em>Hubud</em></a>」で作業してみることに。</p>

<h2>場所</h2>

<p>インドネシアのバリ島は日本からやや西にほぼ南下しただけなので、時差は1時間程度。</p>

<iframe src="https://www.google.com/maps/embed?pb=!1m28!1m12!1m3!1d31852094.710968062!2d109.02427855604289!3d12.959360661349752!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!4m13!3e4!4m5!1s0x605d1b87f02e57e7%3A0x2e01618b22571b89!2sTokyo%2C+Japan!3m2!1d35.6894875!2d139.6917064!4m5!1s0x2dd23d0d964ec3b7%3A0x4030bfbca7d2d30!2sUbud%2C+Gianyar%2C+Bali%2C+Indonesia!3m2!1d-8.5078075!2d115.2643794!5e0!3m2!1sen!2sjp!4v1450422572014" width="600" height="450" frameborder="0" style="border:0" allowfullscreen></iframe>


<br />


<p>山岳エリアにあるウブドという地域。</p>

<iframe src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d898423.1663660748!2d115.13694999999998!3d-8.4778!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x2dd23d0d964ec3b7%3A0x4030bfbca7d2d30!2sUbud%2C+Gianyar%2C+Bali%2C+Indonesia!5e1!3m2!1sen!2sjp!4v1450421799812" width="600" height="450" frameborder="0" style="border:0" allowfullscreen></iframe>


<br />


<br />


<p>そこにある<a href="https://en.wikipedia.org/wiki/Ubud_Monkey_Forest"><strong>Monkey Forest</strong></a>というジャングルの近く。猿がそこら中に。</p>

<p><img src="https://lh3.googleusercontent.com/-L5ndSsoluTDH-7Zt2rhHSascEPf5IH6EKXWXGvC04lqMfYxVngPZYbE1I3k1R23ccnPWcS0WOVD3vAHqE_jGBdVqnO4Aw0Hl1765UWbeRKKTfPu_6_lk0iJF5u9TkbuIpnxhB2DhJpqlXZUStBSK1UzfBsAvST8owOpUu2D7m157ZWauzH_PwDPu3d2nWzReiLG4fO30_iJxY26I3bSzm3Z1dQrCMVm4Kks7deGJ1GqGi3gsW4QD7L-uRA-4_G2RmI2yThUJxbiEVob4tNqrGcVe8UpnR7NzXtp7eGBz9Zucb2vKB33VJi8Z26A6St3F9Tl8W8IUaqaUv0VVNTT6SHzronazA0FGgFKlb2_-Lp16ZIjqWfoOWMmHSm87avAUUOEqCro7zfSoPatAaByPG7cZELHm9mElVd-zziMmDPB-oXU61fypbP-r7N9gdqFRu4_ZMu7FSIjKGzji6o6jGKoqqYU8tt9neZANW7fH0vkn1S9Y8M2KJVbOInaeKSlbqIbnPJaDuq8WrTOjH09pMA69-QhIvEx9rlHaQ3IzMrXxKQuh2LzXK_8cGF8ZjfZFuyy=w911-h683-no"></p>

<h2>Hubud</h2>

<p><em>HUB in UBUD</em>なので<strong>Hubud</strong>という名称。</p>

<p><img src="https://lh3.googleusercontent.com/dYMqwsLYp2oaJKEASxAYUMMLo1C5ZpduSKFWKpRORREs69OUh_RV5igYhGucTrY6oWhJwnzH_yHy87UDtAU89E4bAnDorn3HAIAKQzy4s2Crd2nzku3nXdu00oqK7s52DzlCMJxJ6-rUzoHtC2HHAqLWfkf9QOpq_mHYFpQNLAE1DB4076mhLSV_1ACx29J-cgaBLaJxW_UNWmhQnFtCCW8WKRdSTQcyEOfbELt3WsdTRE5fPMex6ko0ZaAZxzKH4gLWPDM3QBs-oTMchZc2ZzUGK-atDRVvDckprQcnUzbv73zzFPmik1nf8vfuETzAAF5aKSjz1uyHwSjHUah2_jWTbATGA2pMeRRKd44M42e1zeshxCY1LhtLU76pt6bhy_hkTs6x93YNRAQahkr28D0l5cmuIbcZjFa0egVBrT_OaN6zM0RjU35JMCQoqNzukh9NhzrT-CGNVFdgQabjP7lxdvBeTBlZJ5xHneuN2CmrJWvOZL4nA42koIbmLD3Os4F5y-mkp4oVGbHgd5Qg8eyeyCqBQiw-VIc9jT1cyo3bQEXUh1cnOcbx-CNV7b-7sAcl=w513-h683-no"></p>

<p>$60〜の月額プランを支払う事によって、館内で使える時間数が決まる。平日は24時間アクセス可能で、土日は22時ぐらいに閉店。（2015年12月現在）</p>

<p>今回は$60(+$3の処理手数料)を事前でPaypalで払って、25時間プランに加入。</p>

<p>ちなみに、bitcoinでも支払い可能。</p>

<p>中にはbitcoin自販機も！</p>

<p><img src="https://lh3.googleusercontent.com/UY-A9g8-ONJU8Aay5xcWsLRg83oCVKqlbiUtxmBHOGbxHNBzhxu6hb-rRIQCjP-sPkQi0xes-5-1mO9aNb4R_pi07Eu73KxhscSPcuXQKdp7w1lmzHvLAjscGqGh2Pu6UdTTfv1G7esdfdetrCgHTg_uX5GscCuYhP4iE8WMDLrkLcgCfPBHL2lK3xGU4aJWaJnhM1T-OWC4yzoWp3EsB3USh-_R-M961n96fVlcY9V8vQVSonOvG0-NHsZc544cPy9Y9eh1EyRqjfpsV_nQdYOFh9EXQhpowReXYCccMMZvYKspBdZE_2AtENbmF9p_NYEYbeLHWM9YjFH5YofX-SGGWtSJTrqL_ZSS2W0-0qG_FqlE-LWpL9CkvssOYDWrLe0NlRFig_VjcDDKldpECGdhs03DyfR0ApbtH4Jczs-Cwjc9t0qi3beY03w1uSm1xP1wsUq0KishQOgkFSdQhr9yW8sQ-mtwv9N3Ds6pt0XqN_omSw-grmomU1o6MAO1x7-DpljNq7-E1_SNc485gmy412hXH0tDoAO8Os6Fbn6OlBoIRf5UCCKlM-nIJ2owx4Hn=w513-h683-no"></p>

<p>館内には24時間いつでも入れるので時間のトラッキングはどうなってるかというと、恐らく登録時にノートのwifiを設定したので、そのmac addressで識別していると推定。</p>

<h2>内装</h2>

<p>リラックスした感じでアットホームな雰囲気。</p>

<p><img src="https://lh3.googleusercontent.com/uBAu7HirXeAKsONRaXh_vqc2mP5SmPpqF4oXoDkD61YPsNl1V5OPpASxWTeEWzu_gHNGli4RjRItoL7PVDYYfMS8WY8_uZFvnB76sMJzQK11n5Gsux2y6aLODXrcNv2ClbxKODcjaqa4-JMLT8WXUjD9Ve65s1D9THyduaHxit4hUOOhFrk2QDsYVjGJLKOkfw5YaoFoASiQhJGZihfrL56cN1ssC0SIGr0DN58nc_1GXQDfEE-QlOrf65dECO3gKB6dv7HkvEXdzdzZww0AWIsOWOR6x3Karyy0eopYWY1rg96dMZZbDSuuQ1whEDtxb4PpY5wlBbwYHbzGC0tzaTmekorQm6bm_W3bP0sArMLAJb315Kiwz2XXT3BIAbKox9w6cAi4kBg-hd2DSJa5qEweMwzuF4D-74-eTkbmEPSsipuOt-TwXnlDnwtWAGtU77eIX0I6xOifAGNACZhFRlyfowqXjTDsFm_PIzzu2wmNp6PX1RcDeZPjouXxqBKQNNl3m7jwXmayotOOetKLO04cEzYr05hesUlRfEr0fqVhJQGZw639XFH6ms8HiOhvVKhe=w911-h683-no">
<img src="https://lh3.googleusercontent.com/cvPM3ADw9vgnS-5GEGdeQ49mkmhcueUmMJb4wdEnmjIGRFOBP9SsFRSWKKozqgCg4KUleMXh9kLngoGugIKjhoat6rryv2eg6A09gsdfLSYLWVIanZCbxSkbtsulchAa8kijRz8DcIYlls-ZfC4LgkBQwKlmKeKvEMNmgpRzp7ui4glA64_7xiaj_y9JY2HSqCH3TFTaDHjz7-Xal1lvFnEqSk3YMjErUTU3azihb7GIjuIL30z37LmGRgWd4EJoTSd7kykPhn9WlFRvCwD0AmmJ_YYCVPkqQSiax1ZZdWjfOntAupSW7x6SYIod8Wc3y_v17gGZ0hORkuq8s47fj0dDuHcSWWq7brvV88hTBYQRYNTkCZtGTd62rtG_TQzdUaXLB1egThUQhrvYDhD1YUr9iQA0hcFrhi4ql-XSuX_8Yf0hgZkEIyTES6-VrAVB9gCxcXsQzqh6bzQ3PXZ9z3K_eiZNDyugRxtO1b8no7w9vAlsk-lmbv0Xqqkgdv9d9YOGxISt8n72ISlKLMSZFIo2nLT_Xm8MEpA88t8kmWzAhVK0WwSkzWeuPc9Oax39E-QI=w911-h683-no"></p>

<p>フリーデスクで館内でも中庭でも作業可能。</p>

<p><img src="https://lh3.googleusercontent.com/LZSKtZi9Ze5mayvKLZP0dCvSVq37O3TDZmqJYqvBKHj8Qmc6MgExfm1dSTyKvt3iQkLujEF3EjjYbFsSyTovk3bPWzwYuv0a85Y5nEsP5Prfz-UMm9rXKSd4fVeANMD_9j-e9n24_FehztmLv4Lt83Rx0qXhBSg2QwTGG2udhmRDrMChJFYxt2Qt7kzp6ueGuZXnzJGJRwxub2706QCYyUxdMgvdVp01QtrgxbufZ4XOykfwxVZXi1thiPyAWYLeW3AiqOCZ0TYZPRL2RjfajXZWOs72KYHLyGMjgS-2LNeNE3Mt7vMHFNTlhyh84Occi2I7MUl4gWHR4vkv-DB81093Hpnamzn3m2tRPvwRM64_bQFydreyIGGsbTMwyvVbVPIRQ_k2z3n8mVbwZYAj-zI6RIBs9PM9qYp1hAcU7aHtr7fI1vCjVadPUycH5Eg4McHbSn725NhV6aZdj-83cR6hhg_xL3c1WOFIu338CZfqFr5HSlFmQXXQTrQ19qEuNZjN47oN5urQ4f_PcczBl7rBABzPnTikmBM7cjDZt-yqWdtmrxQIU85wI-h6-9v6dbl3=w911-h683-no"></p>

<p>お気に入りの作業場所。但し、夜になると蚊が出てくるので蚊よけスプレー必須。</p>

<p><img src="https://lh3.googleusercontent.com/x6INaXg6Khuoa-GmfkLAeeQz8Pl3iu-ePtf1gLTRPTYa2RnKrgWb8INtPiUCYbM4KGJOKxQLFjSngvx3cHuT-oRPqcrmZhTzzDb1GnR1Mn1GjQtyOA1QIOguqoFDfLwZGYG3BfHffvSfynYwjIkv2h8JEVXDwWKru8gKLF4oOYEGaCnS06Eb0ZcemsmiURZ0M3ypq8iUxaGtbTp9y54HPvyGFxiIOh6KCxu7AZKzwERk39AznqWpzYzjUCov-OS9N5hETGKHcich7fdF5wEbp4beo_YXBhoPFke1QEk3FlR4nbJ2Y3HnhJ8fWeb5T0XBI0wgy53z2tOsz0f08KcDrkVoCtajjP9rYU--YE_7v-LjZr2fdn9cM-PlqZGP4MToM5SyCTVWZFBDBn3xgzm5hLEaRvUI_ksi-Q-XZbbxLq62mLzAz10nNnWxwh4MVVGXd979cpQH5ASHIJgf1QKi0RHRSiVxj1tJBsA-VB5NOSXd9oarWFdSBjhnCPppErAEcffh_6i09mIZzMI1xOT-1zdHyzbPNTYLYMuucg-gPIkKchlsJByb4b68ic4V48hcEltf=w513-h683-no"></p>

<p>2階にはゆったりソファも。</p>

<p><img src="https://lh3.googleusercontent.com/iy0TIM5szRnddHzynP0Cy0bl1w4OttQOjQBKyocRnrsGh2ZJ7p4pNFZvxKUKcFPBvDEr7x5YkEul-bOmLTsiq2nlcFFC9UWG0LpBi-UFU-AW7798Ojy6qGTgk9nWcNe6i6KYVsDgAYUTF-V7aQ02yJvM6aHCXsle9GnVQinHU43zu5vnq7zxj_koCFRPlmINhgnHA_qXQSX3XPOvNjEoVg1q8uEESPSXgSl6U0df10i2m2jhnhMT3Y6uILLR27yYwL4dYfYB0FCgk6sbmiaQzN778jDKeoqClbwwV3HZzi0P7hdH1nWqSJfZM0OB52H_60BLUEjFo97Fvmz9lRUbbEtVMprMxo3-8zeDFe_HpPoS5IcRqILbS1xzFoKAlW_vxTJNUTWf0Jbji3l5_8Q__lbRgy-6NNlMsJbi3T4V2qlcxuI3Atz8B3w1siXL-pE9F3t2iDhsvCCsYlcMe5TrkjQnxkz8wk_D9GQ0YM_cRqZkXTojo92meWoP2GH-CgmNFJAlVM2bLxTwy5Zy1bBBSMsiMKRaqJmVS3VFUNGyzKKlU4Y0w7uJRfYZS_AErU2q0k0k=w911-h683-no"></p>

<p>free coffee!</p>

<p><img src="https://lh3.googleusercontent.com/Gh-1OBMPuUNcsvXjOdGC8b8f6UDMl1RgC8ta0klYmbW5Zk1ZEm0Z6bMqLpP4VBeNtl9vKm5Aj1mM1ZEbx8OdGyBYH73bchI6G9WC-so306HS5mjUjMOQ8X67S8gamvQjD0koEkqDrJyM8z7lf5C8HfCGEz30nr9sAml0QeBsl5DpqUIWwN-dyitMUKuAV4xtqUjxA2VrK0l-KFAUrlBpAxckudnZgWx7eN3xPCYKq-sS2xPUpkVfkiEZld9Ddp9lpmflbRmlIDHjGHmhKwEDIUdPKOzVODwOdNzbY1GzXPT2lp66Wl22WeyxZXImrHp20qvdNoQfkxRvfovODQKUcT9m5bikx3dBKP79bEKVzrtqznwKETztuPA9worTqdfiyYChEBQAa8Q5Gy7zGsXbJGP4_h175YbYJ5gCMC0Y0ENISX9W4Ru39J5pdzpivHBz_UUnFi42nyfbq6-NwIcI89QVXWVM2hwAl64wJ-zsIHwDHkmhSEXAZW8rlpMaKZAcINyJwV2IRhok-caBU8ShFfirsaty9a9QKuSZnFLjfzYxGzRMRjLC2mLoAw9SM1UBS1If=w911-h683-no"></p>

<h2>通信環境</h2>

<p>宿のwifiや現地のキャリアで買えるSIMカードによる通信品質はそれほど良くなく、時間と場所によってはパケットロスが大量に発生。</p>

<p>しかし、Hubudに引いている回線は帯域が太く、レイテンシーもほとんど感じられずに超快適！ストレスなく通信ができるので日本にいるのとさほど変わらないぐらいの感触。</p>

<p><a href="http://beta.speedtest.net/result/4916884889"><img src="https://lh3.googleusercontent.com/6pStRidXB-O6EdgUvp2hZiRfE6_t25MFrknT_smmfYx3r6ZgN5qqgdRnnwOPTkOcIi9K93tRsOcWS16Mg08WHam3XrfNIaIJywfYcfYzcnCCePI5egFyK2s47GxtXGwjdrrapIy9XBVY6Q0xxlOsWp_N9cQ-tYjjG7ZhSF4J9EtThcV5Di869jrkp4aMlxAsr4SFGT8XikG-oGRYd6Brv9sIgstHrtLOQs-2wrO8rUj6SOpkXwt8umkiabt3mZAWvxB1hxTgcKjPmu0LSxp7-XF0ajNNb_PrVjSUUoEtAfb9XEPQBQ2Hk7Ea9hJeYV3FAUn04MHoFMOw1_9Fd9KuNAF63L28w4x2hR_1S-ISH-GJbdOz7lpvDAE5tg4jkS6QYCsQ5gT7w2qtp8Ro4joofGHu_M6epy-lblzV-ifEF08KpVb3WPe_3Zb9G_kONq1Ai4B5rQFkvB8-APc4uVZSfdkwGEiUNHReMx3LhaYd7agAyjeRcgxKd8p0h05XNEBwyYLjXQBSOD3ULPk6n7j7QBlUiPGSusSs86W9u8SPFnDFOTyRJ7g2SD0v8F-I6-oY9-Iu=w421-h453-no"/></a></p>

<h2>まとめ</h2>

<p>たまには作業場所を替えて仕事して見るのも一興です。異なる環境に身を置くことによって、いつもとは違った感じの集中力が発揮でき、短時間で没頭してproductivityが向上する場面がいくつかありました。（昼間の熱い時間はプールに入って涼んで、夕方から夜まで作業するスタイルが結構効率的でした）また、いろんな国やバックグラウンドの人がいるので会話してみると良い刺激にもなるので是非一度体験してみてはいかがでしょうか。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/10/post-lambda-logs-to-slack/">LambdaのログをSlackで見よう</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-12-10T00:56:00+09:00" pubdate data-updated="true">Dec 10<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://qiita.com/advent-calendar/2015/lambda">今年もやるよ！AWS Lambda縛り Advent Calendar 2015</a>の10日分です。</p>

<h2>背景</h2>

<p>AWS Lambdaで開発してるとちょこちょこ実行ログを見たりします。cliであれば、<a href="https://twitter.com/sgwr_dts">@sgwr_dts</a>さんの<a href="https://github.com/winebarrel/lambchop">lambchop</a>が<code>tail</code>的に使えて素敵なんだけど、後で見返したり、検索したりするので、最近ではログをSlackに通知するようにしているのでその紹介を。</p>

<p>イメージはこんな感じ。</p>

<p><img src="https://lh3.googleusercontent.com/A1fsUgw4m52Db4UeOqR3xaQHIGF940MsbA1tchFkF8Pul-ixO6E=w563-h445-no"></p>

<p>ログはCloudWatch logsに溜まるのでsubscriptionさえ出来れば、別にソースはLambdaじゃなくても良いんですけどね。</p>

<h2>Lambda</h2>

<div><script src='https://gist.github.com/917193e443ff41cdf98b.js?file='></script>
<noscript><pre><code></code></pre></noscript></div>


<p>CloudWatch logsのイベントをparseして、日付の色付けやタイムゾーン変換等ちょっこっと加工してメッセージと共に指定の<code>#channel</code>に飛ばすようにし、別のSlack通知用lambda functionをinvokeしているだけですね。
（Slack用のlambdaは<a href="/blog/2015/08/06/github-to-lambda-to-slack/">以前のエントリ</a>を参照）</p>

<p>何故Slackの部分を別functionにしてるかというと、最小単位の機能の切り出しによる<strong>portability</strong>とcross-account間のinvokeが可能となる<strong>reusability</strong>からです。</p>

<h2>紐付け</h2>

<h3>cloudwatch logsにlambda呼び出しの権限設定</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aws --region ap-northeast-1 lambda add-permission --function-name "cloudwatch_logs" \
</span><span class='line'>  --statement-id "logs-my_lambda" --principal "logs.ap-northeast-1.amazonaws.com" \
</span><span class='line'>  --action "lambda:InvokeFunction" --source-account "123456789012" --source-arn \
</span><span class='line'>  "arn:aws:logs:ap-northeast-1:123456789012:log-group:/aws/lambda/my_lambda:*"</span></code></pre></td></tr></table></div></figure>


<h3>subscription filterの作成</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aws --region ap-northeast-1 logs put-subscription-filter \
</span><span class='line'>  --log-group-name "/aws/lambda/my_lambda" --filter-name logs-my_lambda \
</span><span class='line'>  --filter-pattern ""
</span><span class='line'>  --destination-arn arn:aws:lambda:ap-northeast-1:123456789012:function:cloudwatch_logs`</span></code></pre></td></tr></table></div></figure>


<h2>実行</h2>

<p>これでlambda functionが実行されると、Slackにログが通知されます。</p>

<p><img src="https://lh3.googleusercontent.com/-PgkSA7jGbVTf3w1Eq5CZuvUAN4_bkKpR811Vcij5MlLam22C10=w706-h396-no">
<img src="https://lh3.googleusercontent.com/JKU31Qsd6cOSWe011m8UJaBYljDrXwz08ym0ff79DngGMxDL_y0=w705-h234-no"></p>

<p>うん、見やすい。</p>

<h2>問題点</h2>

<p>これでログが飛ぶようになったのは良いですが、Lambdaが実行されてからSlackへの通知まで10数秒とやや長めの時間がかかってしまうのが現在の難点です。（Immediate Feedbackはないものの履歴や検索用途には十分だけど）</p>

<p>調べてみるとLambdaからCloudWatch logsへの書き出しが一番時間がかかっているのが判明。Logsへ書き出されたら、そこからの処理時間は1〜2秒とちょっと前に<a href="https://aws.amazon.com/about-aws/whats-new/2015/09/near-real-time-processing-of-amazon-cloudwatch-logs-with-aws-lambda/">発表された</a>CloudWatch logsの<em>near realtime processing</em>の通りなので、早く<code>Lambda -&gt; CloudWatch logs</code>も同じような処理時間を実現して欲しいものです。</p>

<p>まあ、別にCloudWatch logsにさえ入れば早いので、lambda logに限らずいろいろ応用できそうですが。</p>

<p>では、Happy Lambda Life!</p>

<p>参考</p>

<ul>
<li><a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/DeveloperGuide/Subscriptions.html#LambdaFunctionExample">http://docs.aws.amazon.com/AmazonCloudWatch/latest/DeveloperGuide/Subscriptions.html#LambdaFunctionExample</a></li>
<li><a href="http://inokara.hateblo.jp/entry/2015/10/18/201212">http://inokara.hateblo.jp/entry/2015/10/18/201212</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/04/elastic-beanstalk-easy-ssh/">Elastic Beanstalkへの簡単ssh</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-04T08:43:00+09:00" pubdate data-updated="true">Nov 4<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>AWS Elastic Beanstalk上で管理されているinstanceにsshするには<code>eb ssh</code>コマンドを使えば割りと簡単に接続できますが、アクセスキーの設定が必要で、開発者が多い場合にそれを発行してばら撒いて管理するのはかなり面倒です（IAM user/roleの割当にしても）。特に極稀にしか接続する必要がない場合。</p>

<p>そこで、API GatewayとLambdaでinstanceのpublic ipを返却するエンドポイントを作り、SSH configを設定すれば誰でもアクセスできるようにしてみました。</p>

<p><img src="https://lh3.googleusercontent.com/vqW8J9ASHnvZSjAZnwS-_4BMxUo37m6FJ3snn1c2j1dgbX1SVybDaz9TN0mG-fVLqKRUGDtUBO4uDbL2L_QILPXYNbKFCaCmG5Au4Ar8mNacZATEX3FjT2L08T-K4-JWwIXRvsd5SM1iwPu6az7ABb28N2ezTM5wp4-B4rB7tIHFzx8ZWCq9EvZQJGFnqVZpZxXEbdGc2edk6J4dd-QgrZRAmzx2XHXSK4oWnWCkbTB1VS-LGIk0ShMbqn1wjj8AugSoHozG1hsufsuEyeNxBN8-6lQowH_O8JWRdJc28ffNtEaQeGr6Xrj66DjjxYZmO_NdS9hnlgFzUAP4t9iWt1cRAVzDHHVXfqeROmtdXc1ogYLwQY3EOMpd42l-YDNzKbp_bi4H4YJ-Mr-pmF91szERTw2avQmc2MGYcUcsOATYxnyz47mNW1f6alfbzeUf1sFwlUZ1FqS3if6CWiaKnqNjRPvHHs8ccV7magouBQ0Qm3_DOgSKsuosLYXZzNYEuPZl1WYv-m2Hnz0pMglMUA42V_7zrl6lY-cleeY=w605-h431-no"></p>

<h2>前提条件</h2>

<ul>
<li>instanceにはログインユーザーのssh keyが登録積み（.ebextensions等で）</li>
<li>ssh localhost可能である</li>
<li>Elastic Beanstalkのenvironment名は数値で終わらない</li>
<li>Auto ScalingのTermination Policyが<code>NewestInstance</code></li>
</ul>


<h2>Lambda</h2>

<p>やってる事は単純で自動的に付与される<code>elasticbeanstalk:environment-name</code>タグのついたinstanceのipを（パラメータに応じて）返却するだけ。複数ある場合は、起動した順で。</p>

<p>せっかくなので新しくサポートされたPythonで記述。</p>

<div><script src='https://gist.github.com/bf735efbec42e1f96d4b.js?file='></script>
<noscript><pre><code></code></pre></noscript></div>


<p>当然、LambdaのIAM roleで<code>ec2:Describe*</code>のAction許可も必要。</p>

<h2>Swagger</h2>

<p>API Gatewayのresourceをコンソールでポチポチ作るのがイヤだったのでAPIの状態を<a href="http://swagger.io/">Swagger</a>で定義してみた。awscliは<a href="http://dev.classmethod.jp/cloud/aws/getting-started-with-api-gateway-lambda-integration/">生REST APIが辛い</a>。</p>

<p>編集しながらドキュメントも見れる<a href="http://editor.swagger.io/#/">online editor</a>が結構便利。</p>

<div><script src='https://gist.github.com/a41059039937ffc8dada.js?file='></script>
<noscript><pre><code></code></pre></noscript></div>


<h2>API Gateway</h2>

<p>Swagger上でYAMLで作成した定義書はjsonとしてexportし、<a href="https://github.com/awslabs/aws-apigateway-importer">aws-apigateway-importer</a>でAPIのresourceやmethodやらを生成する。</p>

<h3>import処理</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./aws-api-import.sh -c swagger.json
</span><span class='line'>2015-11-04 02:23:18,507 INFO - Attempting to create API from Swagger definition. Swagger file: swagger.json
</span><span class='line'>reading from swagger.json
</span><span class='line'>2015-11-04 02:23:18,649 INFO - Parsed Swagger with 2 paths
</span><span class='line'>2015-11-04 02:23:18,655 INFO - Creating API with name EB API
</span><span class='line'>2015-11-04 02:23:19,417 INFO - Removing default model Error
</span><span class='line'>2015-11-04 02:23:19,634 INFO - Removing default model Empty
</span><span class='line'>2015-11-04 02:23:19,872 INFO - Creating model for api id nx3r6d6yhh with name IP
</span><span class='line'>2015-11-04 02:23:20,114 INFO - Generated json-schema for model IP: {"type":"object","properties":{"ip":{"type":"string","description":"IP address."}},"definitions":{}}
</span><span class='line'>2015-11-04 02:23:20,329 INFO - Creating model for api id nx3r6d6yhh with name Error
</span><span class='line'>2015-11-04 02:23:20,338 INFO - Generated json-schema for model Error: {"type":"object","properties":{"code":{"type":"integer","format":"int32"},"message":{"type":"string"},"fields":{"type":"string"}},"definitions":{}}
</span><span class='line'>2015-11-04 02:23:20,770 INFO - Creating resource 'eb' on bd5pqsq37h
</span><span class='line'>2015-11-04 02:23:21,420 INFO - Creating resource '{env_name}' on 8rjsbt
</span><span class='line'>2015-11-04 02:23:22,079 INFO - Creating resource 'ip' on 4cg26s
</span><span class='line'>2015-11-04 02:23:22,931 INFO - Creating method response for api nx3r6d6yhh and method GET and status 200
</span><span class='line'>2015-11-04 02:23:23,144 INFO - Creating new model referenced from response: IPaddresses
</span><span class='line'>2015-11-04 02:23:23,144 INFO - Creating model for api id nx3r6d6yhh with name IPaddresses
</span><span class='line'>2015-11-04 02:23:23,153 INFO - Generated json-schema for model IPaddresses: {"type":"string","definitions":{}}
</span><span class='line'>2015-11-04 02:23:23,770 WARN - Default response not supported, skipping
</span><span class='line'>2015-11-04 02:23:23,772 INFO - Creating method parameter for api nx3r6d6yhh and method GET with name method.request.path.env_name
</span><span class='line'>2015-11-04 02:23:23,998 INFO - Creating method for api id nx3r6d6yhh and resource id md6qcm with method get
</span><span class='line'>2015-11-04 02:23:24,822 INFO - Creating resource '{server_num}' on qmd6mc
</span><span class='line'>2015-11-04 02:23:25,689 INFO - Creating method response for api nx3r6d6yhh and method GET and status 200
</span><span class='line'>2015-11-04 02:23:25,896 INFO - Found reference to existing model IPaddresses
</span><span class='line'>2015-11-04 02:23:26,306 WARN - Default response not supported, skipping
</span><span class='line'>2015-11-04 02:23:26,306 INFO - Creating method parameter for api nx3r6d6yhh and method GET with name method.request.path.env_name
</span><span class='line'>2015-11-04 02:23:26,525 INFO - Creating method parameter for api nx3r6d6yhh and method GET with name method.request.path.server_number
</span><span class='line'>2015-11-04 02:23:26,764 INFO - Creating method for api id nx3r6d6yhh and resource id 5udxeo with method get</span></code></pre></td></tr></table></div></figure>


<p>これでAPI Gateway上に階層が出来上がり。</p>

<p><img src="https://lh3.googleusercontent.com/cM7s04iaMWI73VwJcH3C9lsnFjrrFpw0qqnUCM4hkmKWZiB3Pp0idjace8rxQYPCVwYzpucRKJep1j3CN9rDQ4uG0xJa4iXM_ua_lLo6LjxCus_lXV9aPCanWS17Ab6eVfgzH3wMDS1YvUhBq_6aLl3JmGmQVlZPFAUrOjcT-Xwra2o4VRKgaTbE5LQCvoBkzkylYhe6JECBu-lqBW0T9CnyhEsbJ1KTUwnIvLLTYtvTPtG6xEqoBMiCo26QLrASGg_k5fXW66jB-SH3fK-W-2TlYHwGdvlJunbuJp__AN2RUAhU64IPTQmZS-PfBTknMF273wF0DyqoL4UsS4HCmAMytc4LBx4s3iJdxFlPkMHPQ5eM9Q6REK92yP1a9FUqXKGF15FD9M6njOGvXFQYH8BsDruCa-HvxY7l6J0oj7PjyWwgq3_Jpd13F27rQkAcK13ni-sSB17wTRi-la8Tgu5ZMvnpUYBK-ARup3vHz791VQW-LVcdecok2Sao2wG4sUiUi5pMSOUabX02OMORVCu5OSxCdw-GxGSzikM=w350-h280-no"></p>

<p>後は各<code>GET method</code>でLambdaへの関連付けをし、<code>Integration Request</code>と<code>Integration Response</code>の<code>mapping template</code>でパラメータやレスポンスを設定。（多分、この手順もswaggerで定義できるとは思うけど）</p>

<h3>integration request</h3>

<p><img src="https://lh3.googleusercontent.com/JtD50KDCwP5ggylHzSuD7WiM-fr1QvVkZFpGFKD0efPbe_wvJPR0HbaTihe8wSlBNJzFYHAAwN9ZvKS1-R1WVGqbWT-t5PCdlptIVgJkk8xjDF0HJTRXeFEjF6F5Z2sp5wfY3BMgKZnyAM0CL6Ax5WtLNxCENl1SskcqajLDAapVQP8bj0UMlxUhsATwg9wh6zbS-jKp6tjf8YlkDD3PDFV_jhE2oVnzytNTlKBb5sU_kwMRFOGfQiUIpwgsrPq11af4ETcdFiU99lxa2ey1fgwxIaoEddLNOgMyObSd7LV0ISNY_kbZj0aRi2PFFmUfnQmYfc0UTajjAejDRms08vn6oy0-6kwGRjcKMq8zDSLFMCxgaSU4_2m2zh4T1zo54DJCHRm8ilXg_r3Z2u4IdBBHf4xYdvvs2J0p4ZT6GOQy6tMT0cNAFN5XUQiC6zDVutj2Ia1OQSlhUFRvnXwtivqGdMvpOIyUqoyuJ5RHLhO3hWP90SsW_DuILy6eXAHkSMHHpDPu5uemVBD29KfKsf67GS1bmJPwu5_9gX4=w836-h208-no"></p>

<h3>integration response</h3>

<p><img src="https://lh3.googleusercontent.com/-MuJyoH_nLN5jbjrcTsDW9qfsFUhDt6nHq_gNlYwMhVNZJqYL3C5qrgPwXLrPRXL0oRICG8xGpBVJpsLKIC3KhhFL4eHyo5LPZRVMbCXQ20UfT-tMV-Pt72-Rr7AKkhXDSzLcBANpRyJgioD5VlLb6YfqcnDLpczt1gnCOvnLHeWuuIf8NTa6q8hoGZXKyBo79Xapag_xvzbqco8AzSqu_yUxR6MXArEpp_we0JGhkJJHrve41LXNDX27QfC-Fj84feKgXY9CTgB1ytHWWDT_71gU05NwMdMisuQnAZPg9kRnoze55OBXu6c8TtzN5Idvdgmc9dbeKKxFG0f4bn_pt4lN6ZzOJ0ptOteVl-EpMDPk6M9_kwKerOc1GQbH47MEEYmQTXmoMeUp9ECJwhYdxdqu_LEB6ZxrjOC3VBPP6rE8sxBZJG8od_adtClp4UYU5-LBPm9_DYsde5hThh2su9PVBph8fbk42WE8I6o3BoOSciA1G9eIwfaa99OQh-4NZhJRVIGs7M4uMHVyUnDQk0RqtjFjf7TlCkeRC4=w811-h210-no"></p>

<p>参考：</p>

<ul>
<li><a href="http://qiita.com/yuyakato/items/89fcef9746afbf48977a">Amazon API GatewayでAWS Lambda関数にクエリ文字列をパラメータとして渡す</a></li>
<li><a href="http://qiita.com/ijin/items/6edafc1f351a9de49b54">Amazon API Gatewayで文字列をクォーテーションなしで返却する</a></li>
</ul>


<h3>endpoint</h3>

<p>Deployすれば、以下のAPIでipが取得可能。</p>

<p><code>/$API_ENDPOINT/prod/eb/$EB_ENV_NAME/ip/[n]</code></p>

<p>instance ip一覧</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s https://altvsxa2kj.execute-api.ap-northeast-1.amazonaws.com/prod/eb/my-ebenv-production/ip
</span><span class='line'>54.189.149.5
</span><span class='line'>54.189.168.83</span></code></pre></td></tr></table></div></figure>


<p>特定のinstance ip</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s https://altvsxa2kj.execute-api.ap-northeast-1.amazonaws.com/prod/eb/my-ebenv-production/ip/1
</span><span class='line'>54.189.149.5</span></code></pre></td></tr></table></div></figure>


<p>ipの部分だけ、PATHじゃなくquery paramterにした方がAPI Gatewayの設定がシンプルだったけど、少しでもRESTfulにしたかったもので。（まあ、そもそもjson返してないけど）</p>

<h2>SSH Config</h2>

<p>さて、ここからがキモです。</p>

<p>~/.ssh/config</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Host my-ebenv-production*
</span><span class='line'>  User ec2-user
</span><span class='line'>  StrictHostKeyChecking no
</span><span class='line'>  ProxyCommand ssh -A localhost -W `N=$(grep -o '[0-9]\+$' &lt;&lt;&lt; %h || echo 1); E=$(perl -pe 's/\d+$//' &lt;&lt;&lt; %h); curl -s https://altvsxa2kj.execute-api.ap-northeast-1.amazonaws.com/prod/eb/$E/ip/$N`:%p</span></code></pre></td></tr></table></div></figure>


<p>上記の設定で<code>ssh $EB_ENV_NAME[n]</code>で指定したサーバに接続できるようになります。</p>

<p>仕組みとしては、ホスト名をparseしAPI Gatewayに適切なリクエストを行い、返却されるpublic ipにローカル端末自身を踏み台としてsshする<code>ProxyCommand</code>の設定です。</p>

<p>例えば、2番目（に起動した）のサーバに接続する場合は</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh my-ebenv-production2
</span><span class='line'>Last login: Wed Nov  4 01:19:14 2015 from ndx6-ppp413.tokyo.sannet.ne.jp
</span><span class='line'> _____ _           _   _      ____                       _        _ _
</span><span class='line'>| ____| | __ _ ___| |_(_) ___| __ )  ___  __ _ _ __  ___| |_ __ _| | | __
</span><span class='line'>|  _| | |/ _` / __| __| |/ __|  _ \ / _ \/ _` | '_ \/ __| __/ _` | | |/ /
</span><span class='line'>| |___| | (_| \__ \ |_| | (__| |_) |  __/ (_| | | | \__ \ || (_| | |   &lt;
</span><span class='line'>|_____|_|\__,_|___/\__|_|\___|____/ \___|\__,_|_| |_|___/\__\__,_|_|_|\_\
</span><span class='line'>                                       Amazon Linux AMI
</span><span class='line'>
</span><span class='line'>This EC2 instance is managed by AWS Elastic Beanstalk. Changes made via SSH 
</span><span class='line'>WILL BE LOST if the instance is replaced by auto-scaling. For more information 
</span><span class='line'>on customizing your Elastic Beanstalk environment, see our documentation here: 
</span><span class='line'>http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html</span></code></pre></td></tr></table></div></figure>


<p>1番目の場合は明示的に指定する必要はありません。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh my-ebenv-production</span></code></pre></td></tr></table></div></figure>


<p>また、Auto Scalingでinstanceが増減せずに1台のみの場合はもっとシンプルに記述できます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  ProxyCommand ssh -A localhost -W `curl -s https://altvsxa2kj.execute-api.ap-northeast-1.amazonaws.com/prod/eb/$E/ip`:%p</span></code></pre></td></tr></table></div></figure>


<p>簡単！</p>

<p>でも、よくよく考えたら普通のAuto Scalingの場合でも利用できる事に気付きました。</p>

<h2>まとめ</h2>

<ul>
<li>Swaggerなかなか面白い</li>
<li>API GatewayとLambda便利</li>
<li>Lambda pythonも良い。けど、rubyサポートも早う。。</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/26/aws-re-invent-2015/">AWS re:Invent 2015に参加してきた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-10-26T02:26:00+09:00" pubdate data-updated="true">Oct 26<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>今年で3度目の参加となるAWS re:Invent。
忘れない内に記録を残しておきます。</p>

<h2>Day 0</h2>

<h3>Game Day</h3>

<p>Unicornを貸し出すサービスを展開する仮想のスタートアップ企業にDevOpsチームとして最近入社したという設定。前任者が退職しており、資料が少ない中でサービスオープンに立ち会いつつ、様々な困難に直面するというフルデイ・イベント。
今までのGame Dayと違って面白いのはパフォーマンス・チューニングをしつつも、コストも意識しながらチーム間でスコアを競争するところ。アプリは触れないので、<a href="http://isucon.net/">ISUCON</a>よりは昔やった<a href="/blog/2012/07/03/tuningathon4/">チューニンガソン</a>に近い感じ。</p>

<p>スコアは累積の損益。アーキテクチャによっては利益が出たり損失が出たりする。例えば、多くのリクエストが処理できると利益は増すが、AWSのリソースが多いと費用が掛かって損失になりうる。
当然最初は各チームは赤字から始まり、時間とともに積算した利益によって黒転して行く様が目新しかった。</p>

<p>結果、48チーム中で<strong>6位</strong>。（上位2チームはチートで失格となったので<strong>実質は4位</strong>）</p>

<p><img src="https://lh3.googleusercontent.com/H8zoy7lrftuIo9ZQTN_LsUC3KsiGsNkOJbPzuW4vAxy4o6IOAH8=w547-h298-no"></p>

<div class='embed tweet'><blockquote class="twitter-tweet"><p lang="en" dir="ltr"><a href="https://twitter.com/ijin">@ijin</a> <a href="https://twitter.com/AWSreInvent">@AWSreInvent</a> the rabbit icon was awarded to the team with the fastest response time to a request.0.0005s is not too shabby!</p>&mdash; Kyle Lichtenberg (@KyleLichtenberg) <a href="https://twitter.com/KyleLichtenberg/status/651573816301219840">October 7, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></div>


<p>ちなみに最速レスポンスタイムはうちのチームが叩きだした。</p>

<div class='embed tweet'><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Our team - &quot;Ubercon&quot;! <a href="https://twitter.com/hashtag/reinvent?src=hash">#reinvent</a> <a href="https://twitter.com/hashtag/AWSGameDay?src=hash">#AWSGameDay</a> <a href="http://t.co/dpRu1vicgM">pic.twitter.com/dpRu1vicgM</a></p>&mdash; Michael H. Oshita (@ijin) <a href="https://twitter.com/ijin/status/651544851620700160">October 6, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></div>


<p>詳細は今度日本で開催されるかも知れないので控えておくが、非常に楽しめたので次回は運営側に回って手伝おうかと思います！</p>

<h2>Day 1</h2>

<h3>Keynote</h3>

<p>Andy Jessy副社長による発表。今年のテーマは「<strong>自由</strong>」</p>

<ul>
<li>Amazon QuickSight</li>
<li>Amazon Kinesis Firehose</li>
<li>Amazon Snowball</li>
<li>MariaDB for RDS</li>
<li>AWS Database Migration Service</li>
<li>AWS Schema Conversion Tool</li>
<li>AWS Config Rules</li>
<li>Amazon Inspector</li>
</ul>


<p><img src="https://lh3.googleusercontent.com/SSI_hMC3cjzUSvGPxT49FD26VBeY_QYt_qGoTLDPo8nBLwdmglM=w493-h544-no"></p>

<p><del>Oracle</del>からの自由、解放！</p>

<h3>WRK306 - AWS Professional Services Architecting Workshop</h3>

<p>実在した、ある企業のクラウド移行案件。RFP的なモノがあり、アーキテクチャをチーム内で議論し、最後にそれぞれ各チームが発表していく流れ。
かつてjawsugで主催を手伝ったワールドカフェ形式とほぼ同じだったので、チームメンバーを先導してCacooでさくさく構成図を起こしていく。
他のチームが模造紙にラフスケッチで発表する中、我らは綺麗に正本して、プロジェクターで登壇しながら発表。</p>

<div class='embed tweet'><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">ワークショップはうちらのチームだけCacooで図を書いたので制覇した感がある。 <a href="https://twitter.com/hashtag/reinvent?src=hash">#reinvent</a></p>&mdash; Michael H. Oshita (@ijin) <a href="https://twitter.com/ijin/status/651869691699425281">October 7, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></div>


<p>最後に実際にどう移行したかというAWSチームからの回答。まず、移行フェーズを段階的に分け、最初はシステムをほぼそのままクラウド上に乗せた後に部分的に最適化してコンポーネントを置き換えて行ったという話。最後にLambdaになっていた部分があったのが興味深かった。</p>

<p>早く新サービスに対応したAWS Simple Iconsのアップデートが待たれるところ。</p>

<p><img src="https://lh3.googleusercontent.com/IVrSN7g0MnAfVa6pB4ajQWUZYPmpFMOH6Ych-FedX1HqxCfEHtc=w583-h346-no"></p>

<p>今回提案した内容。</p>

<h3>WRK305 - Zombie Apocalypse Survival: Building Serverless Microservices</h3>

<p><a href="https://ja.wikipedia.org/wiki/%E3%82%BE%E3%83%B3%E3%83%93%E3%81%AB%E3%82%88%E3%82%8B%E4%B8%96%E7%95%8C%E3%81%AE%E7%B5%82%E6%9C%AB">Zombie Apocalypse</a>が起こって、人類存亡の危機！途中まで実装されたチャットルームの機能を拡張・実装して危機を救え！というシナリオの元、LambdaとAPI Gatewayとjavascript sdkで実装されたサーバーレスアーキテクチャのワークショップ。</p>

<p>機能拡張の為に実装が必要なので、設計しながらチーム内で作業分担し、コードをせっせと書いていく。
ゾンビ出現のアラート通知、ヒートマップ描画、アンデッドカウンター、緊急食料倉庫の位置情報配信等、面白い機能要求が盛り沢山。</p>

<p><img src="https://lh3.googleusercontent.com/-UStcIzDdtS42SZTgt657iKvYHWlbcfktbvuCq3-LIioBfrBzgI=w600-h346-no"></p>

<p>ささっとSlack部屋を作り、githubでコードを共有しながらのチームワーク作業。多分、うちらのチームが一番多く実装できた感触。</p>

<p><img src="https://lh3.googleusercontent.com/WZ7nUMvRhoNzixWqjEdCFJ1wJqNH-BqjV4M4cq93mBXBnJ8UPOk=w493-h544-no"></p>

<p>このワークショップはかなりの人気で、開始30分前にすでに長蛇の列が。
運良くぎりぎり最後の参加者として入れたけど、皆どれだけゾンビが好きなんだ。。</p>

<h2>Day 2</h2>

<h3>Keynote</h3>

<p>Wernerl Vogels CTOの発表。</p>

<ul>
<li>Amazon Kinesis Analytics</li>
<li>X1 instance (100 cores, 1TB RAM)</li>
<li>t2.nano instance</li>
<li>Amazon EC2 Container Registry</li>
<li>Lambda

<ul>
<li>VPC support</li>
<li>Long running Functions (300s)</li>
<li>Scheduled Functions</li>
<li>Custom Retry Logic</li>
<li>Python</li>
</ul>
</li>
<li>AWS IOT</li>
</ul>


<p><img src="https://lh3.googleusercontent.com/A4p3UvP0JiMxjpZF7L0zxdMFkU96aOYtZ-BExM2zFERDsebakXw=w493-h543-no"></p>

<p>前日にAndyが7つの自由を語って、当日はWernerが7つの法則を語る。</p>

<h3>WRK308 - AWS + ASK: Teaching Amazon Echo New Skills</h3>

<p>Amazon Echoを使った、Alexaのプログラミングワークショップ。音声によって、Echo経由でLambdaイベントを呼び出し、Alexaサービスと連携するカスタマイズしたスキルセットを実装して行く。</p>

<p>例えば、Alexaに好きな色を覚えさせて、後ほど聞くと答えてくれる機能とか。全てボイスコントロール。<a href="http://yoshidashingo.hatenablog.com/?page=1445224481">吉田さんの英語でも通じた</a>ので、かなり優秀。</p>

<p>新品のEchoを開封して使ったので、最後に貰える物かとささやかに期待したものの、$15のAWSクーポン配布のみ。さすが<del>ケチ</del>FrugalなAmazonさん。</p>

<div class='embed tweet'><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">Alexaとlambdaが連携してEchoが喋った！ <a href="https://twitter.com/hashtag/reinvent?src=hash">#reinvent</a> <a href="http://t.co/V6QpNyj3tK">pic.twitter.com/V6QpNyj3tK</a></p>&mdash; Michael H. Oshita (@ijin) <a href="https://twitter.com/ijin/status/652234646231646208">October 8, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></div>




<div class='embed tweet'><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">Alexは今ユーザ駆動にしか対応してないけど、awsのイベント駆動はtop priorityとの事。そのうち例えばbilling alertを音声で通知できるようになるなぁ。楽しみだ。 <a href="https://twitter.com/hashtag/reinvent?src=hash">#reinvent</a></p>&mdash; Michael H. Oshita (@ijin) <a href="https://twitter.com/ijin/status/652239936968654848">October 8, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></div>


<h3>re:Play</h3>

<p>EDMの若きプリンスDJ、Zeddをシークレットゲストとして呼んでのアフター。</p>

<div class='embed tweet'><blockquote class="twitter-tweet"><p lang="en" dir="ltr">What a view for this secret <a href="https://twitter.com/Zedd">@zedd</a> show, this crowd does not end! <a href="https://twitter.com/hashtag/vegas?src=hash">#vegas</a> <a href="http://t.co/0Itv012o0k">pic.twitter.com/0Itv012o0k</a></p>&mdash; Rukes (@rukes) <a href="https://twitter.com/rukes/status/652400784353595392">October 9, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></div>


<p>もう完全にWernerのパーティー。</p>

<div class='embed tweet'><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">昨夜の <a href="https://twitter.com/hashtag/replay?src=hash">#replay</a> でこの積み上がったコンテナを見て、Docker Swarm を連想した人はさぞ多かったに違いない。 <a href="http://t.co/QxF2MkbHTi">pic.twitter.com/QxF2MkbHTi</a></p>&mdash; Michael H. Oshita (@ijin) <a href="https://twitter.com/ijin/status/652681828441063425">October 10, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></div>




<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/cT676BMT7A8 "></iframe></div>


<p>Zeldaのremixが良かった。</p>

<h3>終わりに</h3>

<p>結局セッションは一つも出なかったです。まあ、ビデオやスライドは公開されるので内容自体は後で把握可能なので別にいいかな。授業を聞きに来た分けでもないし。
それよりも、現地に来ているエンジニアと交流したり、実装まで含んだハンズオンのワークショップをやった方が楽しいし、糧となる。後はトレンドを肌感覚として体感するには良い場所なので行った事ない人には是非オススメしておきたい。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/09/30/hashiconf-2015/">#HashiConf 2015に参加してきた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-09-30T03:11:00+09:00" pubdate data-updated="true">Sep 30<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Portlandで開催された<a href="https://www.hashiconf.com">HashiConf 2015</a>に参加してきました。</p>

<h2>Day 1</h2>

<h3>Keynote</h3>

<p>Founder &amp; CEOのMitchell Hashimotoが登壇。
今までのHashiCorpプロダクトを紹介した上で、新プロダクトの紹介！</p>

<p><img src="https://lh3.googleusercontent.com/kV2iR87ZYBN9LuPjMxGmuPxg1t1xzZLlcgi5LV_y8TwzSvsIOVE=w479-h638-no"></p>

<p><a href="https://nomadproject.io">Nomad</a></p>

<p>コンテナスケジューラ。ちょうどあるサービスの一部のDocker化でスケジューリング方法を考えていたので、グッドタイミング。</p>

<p><img src="https://lh3.googleusercontent.com/PaK-SUH-tybvL7ILwZFFXrYVdylvzw1cu0bFR8rKDadbIRgA8cA=w479-h638-no"></p>

<p><a href="https://ottoproject.io">Otto</a></p>

<p>開発からデプロイまで対応したmicroservicesを念頭に入れたVagrantの後継。</p>

<h3>Operating Consul as an Early Adopter</h3>

<ul>
<li>初期の頃からconsulを運用した苦労話</li>
<li>v0.2から始めた</li>
<li><code>consule-template</code>

<ul>
<li>スケールしない。v0.6ではマシに</li>
<li>大きいクラスタで自身をDDOSする</li>
<li>watchesを使わないでcronで<code>-once</code></li>
</ul>
</li>
<li>consulのDNSが不安定な時期があったので、15秒毎にzone fileを書き出し内部DNSで運用</li>
<li>その他初期バージョンで諸々不具合を発見してArmonと一緒に修正</li>
<li>ご苦労様</li>
</ul>


<h3>HashiCorp Tools in the Modern Enterprise</h3>

<ul>
<li>エンプラだって頑張ってDevOpsしてるもん！</li>
<li>文字多めで眠くなっちゃった。。</li>
<li><a href="https://atlas.hashicorp.com/izanamee">Izanamee</a> イザナミ？</li>
</ul>


<h3>Resillient Infrastructure with Serf</h3>

<ul>
<li>Pagerdutyの人</li>
<li>SerfとChefと自社ツールを組み合わせて堅牢なインフラを構築</li>
<li><a href="https://github.com/PagerDuty/blender">Blender</a> - a modular remote command execution framework</li>
<li><a href="https://github.com/ranjib/serfx">SerfX</a> - a bare minimum ruby client for serf</li>
</ul>


<h3>Genesis: Terraforming a new Firefox crash stat infrastructure</h3>

<ul>
<li>Mozillaの人達による漫才ベースのプレゼン</li>
<li>Firefoxのクラッシュ統計データを受信するインフラの構築について</li>
<li>結構笑いがとれてた</li>
</ul>


<h3>The future of management, and how we&#8217;ll get there</h3>

<p>Puppetの作者Lukeさん。未来に観するディープで知見溢れるトーク</p>

<h2>Day 2</h2>

<h3>Keynote</h3>

<p>HashiCorpの哲学とAtlasの説明（2日目は新製品の発表はなし）</p>

<p><img src="https://lh3.googleusercontent.com/XzbJrBKpfWU73lMGv5tVFmfV90Uvyec7WWiizweiv_uTbZEEusY=w619-h465-no"></p>

<h3>Dockerizing all the Things</h3>

<ul>
<li>Docker社内でのCIでconsul使ってるよって話</li>
<li>あまり面白くなかった</li>
<li>20分も残して終了。。</li>
</ul>


<h3>Automate your Infrastructure</h3>

<p>以下のツールでいろいろ自動化してるよ（ﾌｰﾝ）</p>

<ul>
<li>Terraform</li>
<li>CircleCI</li>
<li>Docker (ECS)</li>
<li>Datadog</li>
<li>Slack</li>
</ul>


<h3>Managing Applications at Scale</h3>

<ul>
<li>CoreOSの人</li>
<li>Nomad vs Kubernetes</li>
<li>CLI demo</li>
</ul>


<h3>Repeatable, Extensible Infra at Yelp</h3>

<ul>
<li>YelpのSite Reliability Engineer</li>
<li>内部ツールで起動、puppetでプロビジョニング</li>
<li>Packerやpuppet managed VPCだったけど、今はTerraform</li>
<li>Smartstack (Service discovery)

<ul>
<li>Nerve</li>
<li>Synapse</li>
<li>Hacheck</li>
<li>qdisc_tools</li>
</ul>
</li>
<li>Sensu</li>
<li>nsone</li>
<li><a href="https://github.com/terraform-community-modules">terraform community modules</a>をたくさん書いたよ</li>
</ul>


<h3>Virtual Machines, Containers, Lambdas? Oh my!</h3>

<ul>
<li>AWSの中の人（DevOps担当）</li>
<li>Microservicesについて</li>
<li>導入の判断基準</li>
<li>VM（EC2, Packer, Terraform/Cloudformatio, Consul)</li>
<li>Container (ECS, Nomad)</li>
<li>Lambda (サーバレスアーキテクチャ。例：<a href="http://squirrelbin.com">SquirrelBin</a></li>
<li>さらっと自社サービスをたっくさん紹介した後、結論はLambdaとAPI Gateway押し</li>
<li>そんなにサービスを詰めこめなくても。。</li>
</ul>


<h2>感想</h2>

<p>Nomadの発表が一番エキサイティングだったけど、こういうカンファレンスは中の人やスピーカーや他のユーザーと直接話せるのが醍醐味。プロダクトの担当者に直接フィードバックを伝えたり、展望を聞いたりできて楽しかったです。また、会場で話した参加者も多種多様でアメリカ以外だとスペイン、オーストラリア、ニュージーランド、インド、日本等がいて、世界中から注目されている感じでした。</p>

<p>第一回目ということで約300人の中規模だけど、このぐらいが皆の距離感近くて良い雰囲気。</p>

<h2>その他</h2>

<ul>
<li>懇親会で飛び込みLTしたかったが会場設備が対応できなく、断念</li>
<li>Portland心地良くて過ごしやすい！</li>
<li>記念にもらったHashiCorpとハシ（箸）をかけたジュークは誰も理解してなかった
（Mitchellが言うには日本人参加者が理解してくれるから良いんだと）</li>
</ul>


<p><img src="https://lh3.googleusercontent.com/50dhedo-8s4QS_7Chw6v1U6Ow58b4d53HHYlVQGQ6hwwuN6CT7c=w427-h320-no"></p>

<p>さて、来週はre:Inventだ！</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/09/27/isucon5-qualifier/">ISUCON5の予選に記念参加してきた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-09-27T17:01:00+09:00" pubdate data-updated="true">Sep 27<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>とあるエンジニアが言い放ちました。</p>

<p>「<em>上位に届かないチームはただの記念参加だよねー。</em>」</p>

<p>というわけで、今年のISUCONは見事に予選落ちしました。</p>

<h3>お題</h3>

<p>「<strong>ISUx</strong>i」というどこか懐かしい響きの「高負荷に耐えられるSNSコミュニティサイト」</p>

<p>友達、記事、コメント、足あと機能が揃っており、以前より複雑度が増したなかなかの凝った作り。</p>

<h3>起こったこと</h3>

<p>これはESIによるpartial cachingが出来るので、Varnishでやってみよう！</p>

<p>と意気込んだものの、エラーが解決できず結局は間に合わずに終了ーーっ。</p>

<h3>やりたかったこと</h3>

<ul>
<li>Varnish + ESI + Redis &amp; MySQL</li>
</ul>


<h3>やれたこと</h3>

<p>具体的な作業内容は今手元にないので、ぼんやりと。</p>

<ul>
<li>MySQLのクエリー修正、パラメータ、Indexの追加</li>
<li>nginxのパラメータ追加</li>
<li>kernelのパラメータ追加</li>
<li>一部 redis化</li>
<li>rubyプロセスの調整</li>
<li>sidekiqのワーカーで遅延書き込み</li>
</ul>


<h3>はまったとこ</h3>

<p>今回はいろいろ初めてがあったので無駄に時間を潰した感じ。</p>

<ul>
<li><code>systemd</code> -
最新のUbuntu 15.04はsystemdなんですね。ずっと14.04 LTSのupstartに慣れていたので、こっちは初めて触わった。</li>
<li><code>apparmor</code> -
設定ファイルをsymlinkでやろうとすると読み込まれず。。こいつのせいだと気づくのにちょっと手間取った。いらない子には怒りの<code>apt-get purge</code>を。</li>
<li><code>mysql</code> -
なんか設定ファイルが/etc/mysql/my.cnf単体じゃなくて、symlinkされたりいろんなディレクトリに散らばってたりで若干戸惑った。後、上記のapparmor関連で設定ファイルがしばらく全然反映されずに。。</li>
<li><code>varnish</code> -
こちらもvclやパラメータ指定が本来<code>/etc/default/varnish</code>で出来るはずが、なかなか反映されずに苦労した。Varnish 4.0のパッケージはapt-getですんなり入るんだけど、起動スクリプトが<code>/etc/init.d/varnish</code>に設置されるのに、そちらは無視され、systemdの方が優先される模様。カスタマイズするには<code>/lib/systemd/system/varnish.service</code>をコピって編集して<code>daemon-reload</code>が必要。詳しくは<a href="http://deshack.net/how-to-varnish-listen-port-80-systemd/">こちら</a></li>
</ul>


<h3>終わりに</h3>

<p>競技内容が確実に進化していて、非常ーーに楽しめました！その分、出題者の苦労が計り知れず。。こんどビールでも奢ります。今年の本戦は残念ながら行けないけど、外野として楽しくポップコーンでも食べながら観戦したい所ですね。</p>

<h3>おまけ</h3>

<p>現在はHashiConfに向けての飛行機の中だけど、悔しいので機内で復習しておきます！</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/23/yapc-asia-tokyo-2015/">YAPC::Asia Tokyo 2015に参加してきた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-08-23T15:27:00+09:00" pubdate data-updated="true">Aug 23<span>rd</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>例年この時期は海外にいるので、なかなか行けなかったYAPC::Asia Tokyo 2015にやっと参加してきた。</p>

<p>スケジュール上、今年は参加できるぞって意気込んでいたら、まさかのSold Out&#8230;</p>

<p>それをtwitter上で嘆いていたら、<a href="https://twitter.com/kenjiskywalker">@kenjiskywalker</a>さんから救いの手が！</p>

<div class='embed tweet'><blockquote class="twitter-tweet"><p lang="ja" dir="ltr"><a href="https://twitter.com/ijin">@ijin</a> Tシャツ付きの前売り券購入したのですが、スピーカー枠で参加できそうなのでお譲りしましょうか？</p>&mdash; kenjiskywalker (@kenjiskywalker) <a href="https://twitter.com/kenjiskywalker/status/619079064880463872">July 9, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></div>


<p>感謝！</p>

<p>さて、一口コメント</p>

<p><strong>Consulと自作OSSを活用した100台規模のWebサービス運用</strong>] - <a href="https://twitter.com/fujiwara">@fujiwara</a></p>

<p><a href="https://github.com/sorah/mamiya">mamiya</a>や<a href="http://aws.amazon.com/codedeploy/">AWS CodeDeploy</a>にインスパイアされた<a href="https://github.com/fujiwara/stretcher">stretcher</a>を使ったイベントベースのdeploy周りが面白かった。s3からの取得失敗時の処理は考えてないといけない。</p>

<p><strong>Conway&#8217;s Law of Distributed Work</strong> - Casey West</p>

<p>最近はリモートワークが殆どなので、なかなか共感できる部分が多かった。コミュニケーション大事。</p>

<p><strong>大規模でも小中規模サービスでも捗る microservices な Web サービスのつくりかた</strong> - <a href="https://twitter.com/yappo">@Yappo</a></p>

<p>どのタイミングでコンポーネントの分割をするか。ちゃんと設計しようねって話</p>

<p><strong>ISUCONの勝ち方</strong> - <a href="https://twitter.com/kazeburo">@kazeburo</a></p>

<p>ポイントがよく纏められていて、うちらのチームでも多くを実践していた。まだ勝ててないけど。
CPUやB+ Treeの気持ちになって考える事が大事。</p>

<p><strong>我々はどのように冗長化を失敗したのか</strong> - <a href="https://twitter.com/kenjiskywalker">@kenjiskywalker</a></p>

<p>Networkが不安定だと、様々な冗長化に仕組みがうまく作動しない。検証はProductionと同じ環境でやりましょう。</p>

<p><strong>Profiling &amp; Optimizing in Go</strong> - Brad Fitzpatrick</p>

<p>Bradさんのライブコーディング。奥が深かった。</p>

<p><strong>LT</strong></p>

<p>どれもこれもハイレベル！</p>

<p>特に素晴らしかったのが、テンポの良い<a href="https://twitter.com/yoku0825">@yoku0825</a>さんの<strong>MySQL 5.7の罠があなたを狙っている</strong> と超早業を披露した<a href="http://conbu.net">CONBU</a>さんの<strong>CONBUの道具箱</strong></p>

<iframe allowfullscreen="" frameborder="0" height="355" marginheight="0" marginwidth="0" scrolling="no" src="//www.slideshare.net/slideshow/embed_code/key/dJ6c2p0tc7QM3B" style="border-width: 1px; border: 1px solid #CCC; margin-bottom: 5px; max-width: 100%;" width="425"> </iframe>


<p> <br /></p>

<div class='embed tweet'><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">突然目の前に無線APが生えてきた <a href="https://twitter.com/hashtag/yapcasia?src=hash">#yapcasia</a> <a href="http://t.co/UWcSzvRv08">pic.twitter.com/UWcSzvRv08</a></p>&mdash; ぷりんたいは求職中です、 (@spacepro_be) <a href="https://twitter.com/spacepro_be/status/635004222291902464">August 22, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></div>


<p>いやー、非常に楽しめました。運営の皆様、ありがとうございました！！</p>

<p>さて、これから出国ー。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/06/github-to-lambda-to-slack/">GitHubのeventをLambdaで処理してSlackへ通知</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-08-06T01:46:00+09:00" pubdate data-updated="true">Aug 6<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ちょっと前にGitHubのeventを<a href="https://aws.amazon.com/lambda/">AWS Lambda</a>で処理して、GitHubやSlackのAPIを叩く仕組みを作ったので、メモ。</p>

<p>材料</p>

<ul>
<li>Github</li>
<li>SNS</li>
<li>KMS</li>
<li>Lambda</li>
<li>Slack</li>
</ul>


<p>やりたいことはこんな感じ。</p>

<p><img src="https://lh3.googleusercontent.com/-aep_hTkw5Mo/VjkHcm612yI/AAAAAAAABbo/00aae3JXUkc/s548-Ic42/github%25252Blambda%25252Bslack%252520%2525281%252529.png"></p>

<p>あるGitHubリポジトリのissuesに特定のコメントが書き込まれると、そのユーザはプロジェクトのteamに自動で追加されて、Slackへ通知が流れるというモノです。</p>

<h2>SNS</h2>

<p>まずは媒介となるSNSの作成。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aws sns create-topic --name github --region ap-northeast-1
</span><span class='line'>{
</span><span class='line'>    "TopicArn": "arn:aws:sns:ap-northeast-1:123456789012:github"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>次にSNSに対してpublishできるIAM userを作成</p>

<p>IAM Policy</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "Version": "2012-10-17",
</span><span class='line'>  "Statement": [
</span><span class='line'>    {
</span><span class='line'>      "Action": [
</span><span class='line'>        "sns:Publish"
</span><span class='line'>      ],
</span><span class='line'>      "Sid": "Stmt0000000000000",
</span><span class='line'>      "Resource": [
</span><span class='line'>        "arn:aws:sns:ap-northeast-1:123456789012:github"
</span><span class='line'>      ],
</span><span class='line'>      "Effect": "Allow"
</span><span class='line'>    }
</span><span class='line'>  ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>GitHub</h2>

<ul>
<li>organization: <code>my_org</code></li>
<li>repository: <code>test</code></li>
<li>team: <code>reader</code></li>
</ul>


<h3>SNS連携</h3>

<p><em>Webhooks &amp; Services</em> からAmazonSNSと連携</p>

<p><img src="https://lh3.googleusercontent.com/u4I9Z_Ing9YzhmVCQhMACwYDVIJxJM7C-aDmyMsNL3o=w328-h190-no"></p>

<p>AWS KEYには先ほど作成したIAMユーザのを利用。SNS topicのarnにはregionが書かれているにも関わらず、GitHubの方では明示的に指定が必要。</p>

<p><img src="https://lh3.googleusercontent.com/kppZQx_RdhyC11LB7a0cPtppDUiKgfZBm6laYvRG3zA=w382-h289-no"></p>

<h3>通知するeventの有効化</h3>

<p>さて、GitHubではSNSの場合、<a href="https://api.github.com/hooks">hooksのjson</a>にある通り、<code>push</code>時のeventにしか対応していないので、</p>

<figure class='code'><figcaption><span>hooks </span><a href='https://api.github.com/hooks'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="s2">&quot;name&quot;</span><span class="err">:</span> <span class="s2">&quot;amazonsns&quot;</span><span class="err">,</span>
</span><span class='line'><span class="s2">&quot;events&quot;</span><span class="err">:</span> <span class="p">[</span>
</span><span class='line'>  <span class="s2">&quot;push&quot;</span>
</span><span class='line'><span class="p">]</span><span class="err">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>GitHubの<a href="https://developer.github.com/v3/orgs/hooks/">Webhook API</a>に従って<code>issue_comment</code>を追加してやります。</p>

<p>先ほどのSNS連携のhook idを取得するには<code>GET /orgs/:org/hooks</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">HOOK_ID</span><span class="o">=</span><span class="k">$(</span>curl -H <span class="s1">&#39;Uer-Agent: ijin&#39;</span> -X GET -s -H <span class="s2">&quot;Authorization: token xxxxxxxxxx&quot;</span> <span class="se">\</span>
</span><span class='line'>https://api.github.com/repos/my_org/test/hooks | jq <span class="s1">&#39;.[].id&#39;</span><span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>編集するには<code>PATCH /orgs/:org/hooks/:id</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -H <span class="s1">&#39;Uer-Agent: ijin&#39;</span> -X PATCH -s -H <span class="s2">&quot;Authorization: token xxxxxxxxxx&quot;</span> <span class="se">\</span>
</span><span class='line'>https://api.github.com/repos/my_org/test/hooks/<span class="nv">$HOOK_ID</span> -d <span class="s1">&#39;{&quot;add_events&quot;: [&quot;issue_comment&quot;]}&#39;</span> | jq .
</span></code></pre></td></tr></table></div></figure>


<p>Web UIからは分からないので、ついでに<code>reader</code> teamのIDも取得しておく</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -H <span class="s1">&#39;Uer-Agent: ijin&#39;</span> -X GET -s -H <span class="s2">&quot;Authorization: token xxxxxxxxxx&quot;</span> <span class="se">\</span>
</span><span class='line'>https://api.github.com/orgs/my_org/teams | jq <span class="s1">&#39;.[] | select(.name==&quot;reader&quot;)&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>（※）User-Agentは<a href="https://developer.github.com/v3/#user-agent-required">必須</a></p>

<p>これで、誰かがコメントをした時にもSNSが飛びます。</p>

<h2>KMS</h2>

<p>lambdaでは以下の認証情報を使うので、予めKMSで暗号化しておく。</p>

<ul>
<li>GitHub token</li>
<li>Slack webhook</li>
</ul>


<p>rubyで暗号化する場合</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;aws-sdk&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;base64&#39;</span>
</span><span class='line'><span class="n">kms</span> <span class="o">=</span> <span class="ss">Aws</span><span class="p">:</span><span class="ss">:KMS</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">region</span><span class="p">:</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
</span><span class='line'><span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span> <span class="n">kms</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">key_id</span><span class="p">:</span> <span class="s2">&quot;alias/ijin&quot;</span><span class="p">,</span> <span class="ss">plaintext</span><span class="p">:</span> <span class="s1">&#39;my plain text code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ciphertext_blob</span>
</span></code></pre></td></tr></table></div></figure>


<p>javascriptの場合</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">aws</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;aws-sdk&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">kms</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">aws</span><span class="p">.</span><span class="nx">KMS</span><span class="p">({</span> <span class="nx">region</span><span class="o">:</span> <span class="s1">&#39;us-east-1&#39;</span> <span class="p">});</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="s1">&#39;my plain text code&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">kms</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">({</span><span class="nx">KeyId</span><span class="o">:</span> <span class="s1">&#39;alias/ijin&#39;</span><span class="p">,</span> <span class="nx">Plaintext</span><span class="o">:</span> <span class="nx">text</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
</span><span class='line'>  <span class="k">else</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">CiphertextBlob</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>こうしておくと、SCMに入れても安心。</p>

<p>また、KMSキーの実行権限もlambdaのroleに紐づけておく。</p>

<p><img src="https://lh3.googleusercontent.com/oMHQ76XC7RQUCR_fEo9JyaMhPKSbnIdhCzjIWurEJ9c=w542-h358-no"></p>

<h2>Lambda</h2>

<p>Lambda function作成時にはSNSをevent sourceとして指定。</p>

<p><img src="https://lh3.googleusercontent.com/uDXkEVLrXT1BdUSbiMu3v5lnwTqCoXOkv_nu07XVxkk=w555-h235-no"></p>

<p>(※) KMSは現在us-eastにしかないので、そこ以外のregionでlambdaを実行する場合は、<code>timeout</code>は若干長めに指定して置くと良さげ</p>

<p>コードはこんな感じ。</p>

<ol>
<li>GitHubからSNS hookを受け取って</li>
<li>コメントした内容が<code>join</code>の場合</li>
<li>KMSによってGitHubのtokenを復号化し</li>
<li>そのユーザをteamへ追加する</li>
<li>その後、別lambda functionでslackへ通知する</li>
</ol>


<div><script src='https://gist.github.com/ef105e192a030571d83f.js?file='></script>
<noscript><pre><code></code></pre></noscript></div>




<div><script src='https://gist.github.com/f83e33a6ae0acd83902a.js?file='></script>
<noscript><pre><code></code></pre></noscript></div>


<p>nodeのlibraryを使うともっとスッキリ書けたけど、1 function 1 fileで纏めたかったのでやや冗長なコードになっちゃいました。。</p>

<h2>実行</h2>

<p>GitHubでコメント</p>

<p><img src="https://lh3.googleusercontent.com/KY7fwR-laXAJBQhJFv9VKzo_ydWFzeKep0G-3kgS0mM=w388-h128-no"></p>

<p>Lambda発動</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="nx">T15</span><span class="o">:</span><span class="mi">42</span><span class="o">:</span><span class="mf">53.108</span><span class="nx">Z</span>   <span class="nx">a09e3c80</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">1</span><span class="nx">e15</span><span class="o">-</span><span class="nx">bbb5</span><span class="o">-</span><span class="mi">55</span><span class="nx">b693433c0e</span>    <span class="nx">user</span><span class="o">:</span> <span class="nx">ijin2</span>
</span><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="nx">T15</span><span class="o">:</span><span class="mi">42</span><span class="o">:</span><span class="mf">53.108</span><span class="nx">Z</span>  <span class="nx">a09e3c80</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">1</span><span class="nx">e15</span><span class="o">-</span><span class="nx">bbb5</span><span class="o">-</span><span class="mi">55</span><span class="nx">b693433c0e</span>    <span class="nx">comment</span><span class="o">:</span> <span class="nx">join</span>
</span><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="nx">T15</span><span class="o">:</span><span class="mi">42</span><span class="o">:</span><span class="mf">55.417</span><span class="nx">Z</span>  <span class="nx">a09e3c80</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">1</span><span class="nx">e15</span><span class="o">-</span><span class="nx">bbb5</span><span class="o">-</span><span class="mi">55</span><span class="nx">b693433c0e</span>    <span class="nx">status</span> <span class="nx">code</span><span class="o">:</span> <span class="mi">200</span>
</span><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="nx">T15</span><span class="o">:</span><span class="mi">42</span><span class="o">:</span><span class="mf">55.418</span><span class="nx">Z</span>  <span class="nx">a09e3c80</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">1</span><span class="nx">e15</span><span class="o">-</span><span class="nx">bbb5</span><span class="o">-</span><span class="mi">55</span><span class="nx">b693433c0e</span>    <span class="nx">response</span><span class="o">:</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;state&quot;</span><span class="o">:</span> <span class="s2">&quot;pending&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;url&quot;</span><span class="o">:</span> <span class="s2">&quot;https://api.github.com/teams/1234567/memberships/ijin2&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="nx">T15</span><span class="o">:</span><span class="mi">42</span><span class="o">:</span><span class="mf">55.418</span><span class="nx">Z</span>  <span class="nx">a09e3c80</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">1</span><span class="nx">e15</span><span class="o">-</span><span class="nx">bbb5</span><span class="o">-</span><span class="mi">55</span><span class="nx">b693433c0e</span>    <span class="nx">Added</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">team</span>
</span><span class='line'><span class="nx">END</span> <span class="nx">RequestId</span><span class="o">:</span> <span class="nx">a09e3c80</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">1</span><span class="nx">e15</span><span class="o">-</span><span class="nx">bbb5</span><span class="o">-</span><span class="mi">55</span><span class="nx">b693433c0e</span>
</span><span class='line'><span class="nx">REPORT</span> <span class="nx">RequestId</span><span class="o">:</span> <span class="nx">a09e3c80</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">1</span><span class="nx">e15</span><span class="o">-</span><span class="nx">bbb5</span><span class="o">-</span><span class="mi">55</span><span class="nx">b693433c0e</span> <span class="nx">Duration</span><span class="o">:</span> <span class="mf">5211.48</span> <span class="nx">ms</span> <span class="nx">Billed</span> <span class="nx">Duration</span><span class="o">:</span> <span class="mi">5300</span> <span class="nx">ms</span> <span class="nx">Memory</span> <span class="nx">Size</span><span class="o">:</span> <span class="mi">128</span> <span class="nx">MB</span>  <span class="nx">Max</span> <span class="nx">Memory</span> <span class="nx">Used</span><span class="o">:</span> <span class="mi">14</span> <span class="nx">MB</span>   
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="nx">T15</span><span class="o">:</span><span class="mi">42</span><span class="o">:</span><span class="mf">56.058</span><span class="nx">Z</span>   <span class="nx">a25c66fc</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">11</span><span class="nx">e5</span><span class="o">-</span><span class="nx">b291</span><span class="o">-</span><span class="mi">25</span><span class="nx">d4ee441689</span>    <span class="nx">Received</span> <span class="nx">event</span><span class="o">:</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;username&quot;</span><span class="o">:</span> <span class="s2">&quot;ijin2&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;icon_url&quot;</span><span class="o">:</span> <span class="s2">&quot;https://avatars.githubusercontent.com/u/12809425?v=3&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;text&quot;</span><span class="o">:</span> <span class="s2">&quot;Added to the team&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="nx">T15</span><span class="o">:</span><span class="mi">42</span><span class="o">:</span><span class="mf">58.310</span><span class="nx">Z</span>  <span class="nx">a25c66fc</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">1</span><span class="nx">e15</span><span class="o">-</span><span class="nx">b291</span><span class="o">-</span><span class="mi">25</span><span class="nx">d4ee441689</span>    <span class="mi">200</span>
</span><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="nx">T15</span><span class="o">:</span><span class="mi">42</span><span class="o">:</span><span class="mf">58.311</span><span class="nx">Z</span>  <span class="nx">a25c66fc</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">1</span><span class="nx">e15</span><span class="o">-</span><span class="nx">b291</span><span class="o">-</span><span class="mi">25</span><span class="nx">d4ee441689</span>    <span class="nx">ok</span>
</span><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">11</span><span class="nx">T15</span><span class="o">:</span><span class="mi">42</span><span class="o">:</span><span class="mf">58.311</span><span class="nx">Z</span>  <span class="nx">a25c66fc</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">1</span><span class="nx">e15</span><span class="o">-</span><span class="nx">b291</span><span class="o">-</span><span class="mi">25</span><span class="nx">d4ee441689</span>    <span class="nx">Successfully</span> <span class="nx">posted</span> <span class="nx">to</span> <span class="nx">Slack</span><span class="o">!</span>
</span><span class='line'><span class="nx">END</span> <span class="nx">RequestId</span><span class="o">:</span> <span class="nx">a25c66fc</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">11</span><span class="nx">e5</span><span class="o">-</span><span class="nx">b291</span><span class="o">-</span><span class="mi">25</span><span class="nx">d4ee441689</span>
</span><span class='line'><span class="nx">REPORT</span> <span class="nx">RequestId</span><span class="o">:</span> <span class="nx">a25c66fc</span><span class="o">-</span><span class="mi">403</span><span class="nx">f</span><span class="o">-</span><span class="mi">1</span><span class="nx">e15</span><span class="o">-</span><span class="nx">b291</span><span class="o">-</span><span class="mi">25</span><span class="nx">d4ee441689</span> <span class="nx">Duration</span><span class="o">:</span> <span class="mf">2268.06</span> <span class="nx">ms</span> <span class="nx">Billed</span> <span class="nx">Duration</span><span class="o">:</span> <span class="mi">2300</span> <span class="nx">ms</span> <span class="nx">Memory</span> <span class="nx">Size</span><span class="o">:</span> <span class="mi">128</span> <span class="nx">MB</span>  <span class="nx">Max</span> <span class="nx">Memory</span> <span class="nx">Used</span><span class="o">:</span> <span class="mi">14</span> <span class="nx">MB</span>   
</span></code></pre></td></tr></table></div></figure>


<p>teamへの追加（招待）</p>

<p><img src="https://lh3.googleusercontent.com/lzamiiNraeHYD7FI6rrb8-403hxjzVRrAqGG6k3sBcc=w474-h191-no"></p>

<p>Slackへ通知</p>

<p><img src="https://lh3.googleusercontent.com/EeEiHydBDc29YhVI6MBUcdj1WUzMXnf_Sis3U-URqhw=w388-h147-no"></p>

<h2>結論</h2>

<p>簡単にできますね。実はこんな風に作っちゃった2週間後ぐらいにAWSの人も似たような<a href="https://aws.amazon.com/blogs/compute/dynamic-github-actions-with-aws-lambda/">ブログ</a>を書いていた事を発見しましたが。まあ、こっちはKMSとSlack使ってるので。。</p>

<p>後、KMSのアイコンが欲しい！</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/02/22/serverlessconf-paris-2018/">ServerlessConf Paris 2018で発表してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/12/31/aws-re-invent-2017/">AWS re:Invent 2017に参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/04/30/serverlessconf-austin-2017/">ServerlessConf Austin 2017に参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/27/ruboty-github-pr-release/">ruboty-github_pr_releaseを作った</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/31/aws-re-invent-2016/">AWS re:Invent 2016に参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/09/serverlessconf-london-2016/">ServerlessConf London 2016に参加してきた。</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/29/aws-gameday-japan-2016/">AWS GameDay Japan 2016を開催してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/28/dockercon-2016/">DockerCon 2016に参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/28/terraforming-api-gatewways/">TerraformでAPI Gatewway</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/31/using-terraform-dev-versions/">Terraformで特定のブランチを使う</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/18/ssh-and-git-on-aws-lambda/">LambdaでSSHやGitを使ってみよう</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/14/monitor-lambda-capacity/">Lambdaの容量を監視しよう</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/18/co-working-in-hubud/">バリ島のHubudでコワークしてきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/10/post-lambda-logs-to-slack/">LambdaのログをSlackで見よう</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/04/elastic-beanstalk-easy-ssh/">Elastic Beanstalkへの簡単ssh</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/26/aws-re-invent-2015/">AWS re:Invent 2015に参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/30/hashiconf-2015/">#HashiConf 2015に参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/27/isucon5-qualifier/">ISUCON5の予選に記念参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/23/yapc-asia-tokyo-2015/">YAPC::Asia Tokyo 2015に参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/06/github-to-lambda-to-slack/">GitHubのeventをLambdaで処理してSlackへ通知</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/02/dynamodb-export-with-datapipeline/">Data PipelineによるDynamoDBのexport</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/01/notes-on-ec2-auto-recovery/">EC2 Auto Recoveryの注意点</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/17/self-healing-with-non-elb-autoscaling4/">Auto Scalingによる自動復旧（AWS Lambda+SNS編）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/27/serverfesta-2015-spring/">サバフェス！2015に参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/31/isucon4-final/">ISUCON4の本戦の思い出</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("ijin", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/ijin" class="twitter-follow-button" data-show-count="false">Follow @ijin</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Michael H. Oshita -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ijin';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
